name : Test Index Image

on:
  pull_request:
    branches:
      - main
    paths:
      - index/**

env:
  IMAGE_NAME: opendatacube/datacube-index"

jobs:
  test-build-index:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Run Dockerized Bootstrapping from Git
      timeout-minutes: 20
      shell: bash
      env:
        PRODUCT_CATALOG : https://raw.githubusercontent.com/GeoscienceAustralia/dea-config/a4f39b485b33608a016032d9987251881fec4b6f/workspaces/sandbox-products.csv
        METADATA_CATALOG : https://raw.githubusercontent.com/GeoscienceAustralia/dea-config/a4f39b485b33608a016032d9987251881fec4b6f/workspaces/sandbox-metadata.yaml
      run: |
        cd index
        docker-compose up -d
        docker-compose exec -T index /code/bootstrap-odc.sh $PRODUCT_CATALOG $METADATA_CATALOG
        docker-compose exec -T postgres psql -U postgres -c "SELECT count(*) from agdc.metadata_type"
        docker-compose exec -T postgres psql -U postgres -c "SELECT count(*) from agdc.dataset_type"
        docker-compose down

      - name: Run Dockerized Tests for S3
        timeout-minutes: 20
        shell: bash
        env:
          AWS_ACCESS_KEY_ID : ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          cd index
          docker-compose up -d
          docker-compose exec -T index datacube system init
          docker-compose exec -T index datacube system check
          echo "Checking InSAR indexing"
          docker-compose exec -T index datacube product add https://raw.githubusercontent.com/GeoscienceAustralia/digitalearthau/develop/digitalearthau/config/products/cemp_insar_alos_displacement.yaml
          docker-compose exec -T index s3-to-dc "s3://dea-public-data/cemp_insar/insar/displacement/alos/2010/**/*.yaml" cemp_insar_alos_displacement
          echo "Checking Indexed Datasets Count"
          docker-compose exec -T postgres psql -U postgres -c "SELECT count(*) from agdc.dataset"
          echo "Checking STAC indexing"
          docker-compose exec -T index datacube product add https://raw.githubusercontent.com/digitalearthafrica/config/master/products/esa_s2_l2a.yaml
          docker-compose exec -T index s3-to-dc --stac "s3://sentinel-cogs/sentinel-s2-l2a-cogs/2020/S2A_32NNF_20200127_0_L2A/*.json" s2_l2a
          echo "Checking STAC API indexing"
          docker-compose exec -T index stac-to-dc --bbox='-20,30,20,40' --limit=10 --collections='sentinel-s2-l2a-cogs' --datetime='2020-08-01/2020-08-31' s2_l2a
          echo "Checking Indexed Datasets Count (including STAC)"
          docker-compose exec -T postgres psql -U postgres -c "SELECT count(*) from agdc.dataset"
          docker-compose down
